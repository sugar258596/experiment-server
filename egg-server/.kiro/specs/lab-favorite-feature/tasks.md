# 实现计划

- [x] 1. 后端：扩展Lab Service添加收藏状态
  - 在Lab Service中实现attachFavoriteStatus方法，为实验室数据附加当前用户的收藏状态
  - 该方法应支持单个实验室对象和实验室数组
  - 当userId为null或undefined时，所有isFavorite应为false
  - 使用单次数据库查询获取用户的所有收藏记录，避免N+1查询问题
  - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

- [x] 1.1 编写属性测试：收藏数据正确性
  - **属性 3: 收藏数据正确性**
  - **验证: 需求 3.1, 3.2, 3.3, 3.4**

- [x] 1.2 编写属性测试：未登录用户收藏状态
  - **属性 4: 未登录用户收藏状态**
  - **验证: 需求 3.5**

- [x] 2. 后端：修改Lab Service查询方法
  - 修改findAll方法，在返回数据前调用attachFavoriteStatus
  - 修改findById方法，在返回数据前调用attachFavoriteStatus
  - 修改getPopularLabs方法，在返回数据前调用attachFavoriteStatus
  - 从ctx.state.user.sub获取当前登录用户ID
  - _需求: 3.1, 3.2_

- [x] 3. 后端：修改Lab Controller传递用户信息
  - 修改index方法，从JWT token获取用户ID并传递给service
  - 修改show方法，从JWT token获取用户ID并传递给service
  - 修改getPopularLabs方法，从JWT token获取用户ID并传递给service
  - 处理未登录用户的情况（userId为null）
  - _需求: 3.1, 3.2, 3.5_

- [x] 4. 前端：实验室列表页添加收藏功能
  - 在labs/index.vue中实现handleToggleFavorite方法
  - 调用toggleFavoriteApi进行收藏切换
  - 在LabCard组件上绑定@toggleFavorite事件
  - 操作成功后显示成功提示并刷新列表
  - 操作失败后显示错误提示并保持原状态
  - _需求: 1.1, 1.4, 1.5, 1.6_

- [ ]* 4.1 编写属性测试：收藏切换正确性
  - **属性 1: 收藏切换正确性**
  - **验证: 需求 1.1, 2.4**

- [ ]* 4.2 编写属性测试：收藏操作反馈
  - **属性 6: 收藏操作反馈**
  - **验证: 需求 1.5, 1.6**

- [x] 5. 前端：实验室详情页添加收藏功能
  - 在labs/detail.vue中添加收藏按钮UI（在页面顶部，预约按钮旁边）
  - 实现handleToggleFavorite方法调用toggleFavoriteApi
  - 添加isFavorited计算属性，基于lab.isFavorite
  - 添加favoriteButtonText计算属性，显示"收藏"或"已收藏"
  - 添加favoriteButtonIcon计算属性，显示对应的图标
  - 操作成功后更新本地状态并显示提示
  - _需求: 2.1, 2.2, 2.3, 2.4, 2.5_

- [ ]* 5.1 编写属性测试：收藏状态显示一致性
  - **属性 2: 收藏状态显示一致性**
  - **验证: 需求 1.2, 1.3, 2.2, 2.3, 2.5**

- [x] 6. 前端：优化收藏列表页
  - 确认favorites/index.vue已正确实现handleToggleFavorite
  - 确认取消收藏后会刷新列表
  - 确认空状态提示正常显示
  - 确认加载状态正常显示
  - _需求: 4.1, 4.2, 4.4, 4.5_

- [ ]* 6.1 编写属性测试：收藏列表完整性
  - **属性 5: 收藏列表完整性**
  - **验证: 需求 4.1**

- [ ]* 6.2 编写属性测试：收藏列表更新正确性
  - **属性 9: 收藏列表更新正确性**
  - **验证: 需求 4.4**

- [x] 7. 前端：添加防抖和乐观更新
  - 在收藏按钮点击时添加loading状态，防止重复点击
  - 实现乐观更新：点击后立即更新UI状态
  - 如果API调用失败，回滚UI状态
  - 在所有收藏操作中添加try-catch错误处理
  - _需求: 1.6, 5.4_

- [x] 8. 后端：添加数据库索引优化
  - 在favorites表的(userId, labId)上创建复合索引
  - 验证索引创建成功
  - _需求: 性能优化_

- [x] 9. 测试：跨页面状态一致性验证
  - 在实验室列表页收藏实验室
  - 导航到详情页验证isFavorite为true
  - 导航到收藏列表验证实验室出现在列表中
  - 在详情页取消收藏
  - 返回列表页验证isFavorite为false
  - 返回收藏列表验证实验室已移除
  - _需求: 5.1, 5.2, 5.3_

- [ ]* 9.1 编写属性测试：跨页面状态一致性
  - **属性 7: 跨页面状态一致性**
  - **验证: 需求 5.1, 5.2, 5.3**

- [ ]* 9.2 编写属性测试：收藏状态持久性
  - **属性 8: 收藏状态持久性**
  - **验证: 需求 5.5**

- [x] 10. 最终检查点
  - 确保所有测试通过，如有问题请询问用户
